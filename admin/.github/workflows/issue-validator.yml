name: Issue Validator

on:
  issues:
    types: [opened, edited]
  # æ·»åŠ å¹¶å‘æ§åˆ¶ï¼Œé¿å…é‡å¤è¿è¡Œ
concurrency:
  group: 'issue-validator-${{ github.event.issue.number }}'
  cancel-in-progress: true

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  validate-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Issue Format
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';

            console.log('ğŸ” å¼€å§‹éªŒè¯ Issue æ ¼å¼...');
            console.log(`Issue æ ‡é¢˜: ${issue.title}`);
            console.log(`Issue æè¿°é•¿åº¦: ${body.length}`);

            let validationErrors = [];
            let debugInfo = [];

            // æ£€æŸ¥æ˜¯å¦åŒ…å«å¿…è¦çš„ç¯å¢ƒä¿¡æ¯
            const hasOS = body.includes('### æ“ä½œç³»ç»Ÿ') && body.includes('- [ ]');
            const hasBrowser = body.includes('### æµè§ˆå™¨ç‰ˆæœ¬') && body.includes('- [ ]');
            const hasVersion = body.includes('### ä»“åº“ä»£ç ç‰ˆæœ¬') && body.includes('- [ ]');

            // æ£€æŸ¥æ˜¯å¦åŒ…å«é‡ç°æ­¥éª¤æˆ–åŠŸèƒ½æè¿°ï¼ˆä»…åœ¨ bug ç±»å‹æ—¶æ£€æŸ¥ï¼‰
            const isBug = issue.labels.some(label => 
              typeof label === 'string' ? label === 'bug' : label.name === 'bug'
            );
            const hasSteps = body.includes('## ğŸ“‹ é‡ç°æ­¥éª¤') || body.includes('## ğŸ¯ é—®é¢˜æè¿°');

            // æ£€æŸ¥æ˜¯å¦åŒ…å«æ£€æŸ¥æ¸…å•
            const hasChecklist = body.includes('## âœ… æ£€æŸ¥æ¸…å•') && body.includes('- [ ]');

            if (!hasOS) {
              validationErrors.push('âŒ **ç¼ºå°‘æ“ä½œç³»ç»Ÿä¿¡æ¯**');
              debugInfo.push('æœªæ‰¾åˆ°æ“ä½œç³»ç»Ÿé€‰æ‹©é¡¹ï¼ˆéœ€è¦åŒ…å« "### æ“ä½œç³»ç»Ÿ" å’Œ "- [ ]" æ ¼å¼ï¼‰');
            } else {
              console.log('âœ… æ“ä½œç³»ç»Ÿæ£€æŸ¥é€šè¿‡');
            }

            if (!hasBrowser) {
              validationErrors.push('âŒ **ç¼ºå°‘æµè§ˆå™¨ç‰ˆæœ¬ä¿¡æ¯**');
              debugInfo.push('æœªæ‰¾åˆ°æµè§ˆå™¨ç‰ˆæœ¬å¡«å†™é¡¹ï¼ˆéœ€è¦åŒ…å« "### æµè§ˆå™¨ç‰ˆæœ¬" å’Œ "- [ ]" æ ¼å¼ï¼‰');
            } else {
              console.log('âœ… æµè§ˆå™¨ç‰ˆæœ¬æ£€æŸ¥é€šè¿‡');
            }

            if (!hasVersion) {
              validationErrors.push('âŒ **ç¼ºå°‘ä»“åº“ä»£ç ç‰ˆæœ¬ç¡®è®¤**');
              debugInfo.push('æœªæ‰¾åˆ°ä»“åº“ä»£ç ç‰ˆæœ¬ç¡®è®¤é¡¹ï¼ˆéœ€è¦åŒ…å« "### ä»“åº“ä»£ç ç‰ˆæœ¬" å’Œ "- [ ]" æ ¼å¼ï¼‰');
            } else {
              console.log('âœ… ä»“åº“ä»£ç ç‰ˆæœ¬æ£€æŸ¥é€šè¿‡');
            }

            // åªåœ¨ bug ç±»å‹æ—¶æ£€æŸ¥é‡ç°æ­¥éª¤
            if (isBug && !hasSteps) {
              validationErrors.push('âŒ **ç¼ºå°‘é‡ç°æ­¥éª¤æˆ–é—®é¢˜æè¿°**');
              debugInfo.push('æœªæ‰¾åˆ°é‡ç°æ­¥éª¤æˆ–é—®é¢˜æè¿°ï¼ˆéœ€è¦åŒ…å« "## ğŸ“‹ é‡ç°æ­¥éª¤" æˆ– "## ğŸ¯ é—®é¢˜æè¿°"ï¼‰');
            } else if (isBug) {
              console.log('âœ… é‡ç°æ­¥éª¤æ£€æŸ¥é€šè¿‡');
            } else {
              console.log('â„¹ï¸ é bug ç±»å‹ï¼Œè·³è¿‡é‡ç°æ­¥éª¤æ£€æŸ¥');
            }

            if (!hasChecklist) {
              validationErrors.push('âŒ **ç¼ºå°‘æ£€æŸ¥æ¸…å•**');
              debugInfo.push('æœªæ‰¾åˆ°æ£€æŸ¥æ¸…å•ï¼ˆéœ€è¦åŒ…å« "## âœ… æ£€æŸ¥æ¸…å•" å’Œ "- [ ]" æ ¼å¼ï¼‰');
            } else {
              console.log('âœ… æ£€æŸ¥æ¸…å•æ£€æŸ¥é€šè¿‡');
            }

            if (validationErrors.length > 0) {
              console.log('âŒ Issue æ ¼å¼éªŒè¯å¤±è´¥');
              console.log('é”™è¯¯è¯¦æƒ…:', validationErrors);
              
              // æ·»åŠ æ ‡ç­¾ï¼ˆé¦–æ¬¡åªæ·»åŠ  needs-infoï¼‰
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['needs-info']
                });
                console.log('âœ… å·²æ·»åŠ  needs-info æ ‡ç­¾');
              } catch (e) {
                console.log('âš ï¸ æ·»åŠ æ ‡ç­¾å¤±è´¥:', e.message);
              }
              
              // æ·»åŠ è¯¦ç»†è¯„è®º
              const commentBody = `âš ï¸ **Issue æ ¼å¼éªŒè¯å¤±è´¥**\n\n### âŒ å‘ç°çš„é—®é¢˜ï¼š\n\n${validationErrors.join('\n\n')}\n\n### âš ï¸ é‡è¦æé†’\n- ä¸ç¬¦åˆæ ¼å¼è¦æ±‚çš„ Issue å°†åœ¨ 24 å°æ—¶åè‡ªåŠ¨å…³é—­\n- è¯·ä½¿ç”¨æä¾›çš„æ¨¡æ¿åˆ›å»º Issue\n\nè¯·å®Œå–„ä¿¡æ¯åé‡æ–°æäº¤ï¼Œè°¢è°¢ï¼`;
              
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: commentBody
                });
                console.log('âœ… å·²æ·»åŠ è¯¦ç»†è¯„è®º');
              } catch (e) {
                console.log('âš ï¸ æ·»åŠ è¯„è®ºå¤±è´¥:', e.message);
              }
              
              core.setFailed(`Issue format validation failed: ${validationErrors.join(', ')}`);
            } else {
              console.log('âœ… Issue æ ¼å¼éªŒè¯é€šè¿‡');
              
              // ç§»é™¤ invalid å’Œ needs-info æ ‡ç­¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
              const labelsToRemove = ['invalid', 'needs-info'];
              for (const label of labelsToRemove) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    name: label
                  });
                  console.log(`âœ… å·²ç§»é™¤ ${label} æ ‡ç­¾`);
                } catch (e) {
                  // æ ‡ç­¾ä¸å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
                  console.log(`â„¹ï¸ ${label} æ ‡ç­¾ä¸å­˜åœ¨ï¼Œæ— éœ€ç§»é™¤`);
                }
              }
              
              // å¦‚æœ issue ä¹‹å‰è¢«å…³é—­äº†ï¼Œé‡æ–°æ‰“å¼€
              if (issue.state === 'closed') {
                try {
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    state: 'open'
                  });
                  console.log('âœ… å·²é‡æ–°æ‰“å¼€ Issue');
                } catch (e) {
                  console.log('âš ï¸ é‡æ–°æ‰“å¼€ Issue å¤±è´¥:', e.message);
                }
              }
              
              // æ·»åŠ æˆåŠŸè¯„è®º
              const successComment = `âœ… **Issue æ ¼å¼éªŒè¯é€šè¿‡ï¼**\n\næ‰€æœ‰æ ¼å¼è¦æ±‚éƒ½å·²æ»¡è¶³ï¼ŒIssue å·²å‡†å¤‡å°±ç»ªã€‚`;
              
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: successComment
                });
                console.log('âœ… å·²æ·»åŠ æˆåŠŸè¯„è®º');
              } catch (e) {
                console.log('âš ï¸ æ·»åŠ æˆåŠŸè¯„è®ºå¤±è´¥:', e.message);
              }
            }
