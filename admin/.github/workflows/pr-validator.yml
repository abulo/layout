name: PR Validator

on:
  pull_request:
    types: [opened, edited, synchronize]

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate PR Format
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            const commits = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            console.log('ğŸ” å¼€å§‹éªŒè¯ PR æ ¼å¼...');
            console.log(`PR æ ‡é¢˜: ${pr.title}`);
            console.log(`PR æè¿°é•¿åº¦: ${body.length}`);
            console.log(`Commit æ•°é‡: ${commits.data.length}`);

            let validationErrors = [];
            let debugInfo = [];

            // æ£€æŸ¥æ˜¯å¦å…³è”äº† issue
            const hasIssueLink = body.includes('**å…³è” Issue:** #') && !body.includes('**å…³è” Issue:** #_____');
            if (!hasIssueLink) {
              validationErrors.push('âŒ **å¿…é¡»å…³è”ä¸€ä¸ª issue**ï¼ˆæ ¼å¼ï¼š#issue_numberï¼‰');
              debugInfo.push('æœªæ‰¾åˆ°æœ‰æ•ˆçš„ Issue å…³è”ï¼ˆéœ€è¦åŒ…å« "**å…³è” Issue:** #" æ ¼å¼ï¼‰');
            } else {
              console.log('âœ… Issue å…³è”æ£€æŸ¥é€šè¿‡');
            }

            // æ£€æŸ¥æ˜¯å¦åªæœ‰ä¸€ä¸ª commit
            if (commits.data.length > 1) {
              validationErrors.push(`âŒ **PR åªèƒ½åŒ…å«ä¸€ä¸ª commit**ï¼Œå½“å‰æœ‰ ${commits.data.length} ä¸ª commitï¼Œè¯·ä½¿ç”¨ rebase åˆå¹¶å¤šä¸ª commit`);
              debugInfo.push(`æ£€æµ‹åˆ° ${commits.data.length} ä¸ª commitï¼Œéœ€è¦åˆå¹¶ä¸º 1 ä¸ª`);
            } else {
              console.log('âœ… Commit æ•°é‡æ£€æŸ¥é€šè¿‡');
            }

            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº† PR ç±»å‹
            const validTypes = [
              'feat', 'i18n', 'fix', 'docs', 'style', 'refactor', 'perf', 'test', 
              'build', 'ci', 'chore', 'revert', 'wip', 'workflow', 'types', 'release'
            ];

            const hasPRType = body.includes('- [x]') && (
              body.includes('æ–°åŠŸèƒ½') ||
              body.includes('Bug ä¿®å¤') ||
              body.includes('æ–‡æ¡£æ›´æ–°') ||
              body.includes('ä»£ç é‡æ„') ||
              body.includes('æ€§èƒ½ä¼˜åŒ–') ||
              body.includes('æµ‹è¯•ç›¸å…³') ||
              body.includes('æ„å»º/CI ç›¸å…³') ||
              body.includes('å›æ»š') ||
              body.includes('å¼€å‘ä¸­') ||
              body.includes('å‘å¸ƒç›¸å…³')
            );
            if (!hasPRType) {
              validationErrors.push('âŒ **å¿…é¡»é€‰æ‹© PR ç±»å‹**ï¼ˆåªèƒ½é€‰æ‹©ä¸€ä¸ªï¼‰');
              debugInfo.push('æœªæ‰¾åˆ°æœ‰æ•ˆçš„ PR ç±»å‹é€‰æ‹©ï¼ˆéœ€è¦åŒ…å« "- [x]" å’Œç±»å‹æè¿°ï¼‰');
            } else {
              console.log('âœ… PR ç±»å‹æ£€æŸ¥é€šè¿‡');
            }

            // æ£€æŸ¥æ˜¯å¦å®Œæˆäº†æ£€æŸ¥æ¸…å•
            console.log('ğŸ” æ£€æŸ¥æ¸…å•éªŒè¯è¯¦æƒ…:');
            console.log('- åŒ…å« "## æ£€æŸ¥æ¸…å•":', body.includes('## æ£€æŸ¥æ¸…å•'));
            console.log('- åŒ…å« "## ğŸ“‹ æ£€æŸ¥æ¸…å•":', body.includes('## ğŸ“‹ æ£€æŸ¥æ¸…å•'));
            console.log('- åŒ…å« "- [x]":', body.includes('- [x]'));
            console.log('- åŒ…å« "æˆ‘çš„æäº¤ä¿¡æ¯éµå¾ªäº† [Conventional Commits]":', body.includes('æˆ‘çš„æäº¤ä¿¡æ¯éµå¾ªäº† [Conventional Commits]'));
            console.log('- åŒ…å« "Conventional Commits":', body.includes('Conventional Commits'));
            console.log('- åŒ…å« "æˆ‘çš„ PR åªåŒ…å«ä¸€ä¸ª commit":', body.includes('æˆ‘çš„ PR åªåŒ…å«ä¸€ä¸ª commit'));
            console.log('- åŒ…å« "æˆ‘ä½¿ç”¨äº† rebase è€Œä¸æ˜¯ merge":', body.includes('æˆ‘ä½¿ç”¨äº† rebase è€Œä¸æ˜¯ merge'));

            const hasChecklist = (body.includes('## æ£€æŸ¥æ¸…å•') || body.includes('## ğŸ“‹ æ£€æŸ¥æ¸…å•')) && 
              body.includes('- [x]') && 
              (body.includes('æˆ‘çš„æäº¤ä¿¡æ¯éµå¾ªäº† [Conventional Commits]') || body.includes('Conventional Commits')) &&
              body.includes('æˆ‘çš„ PR åªåŒ…å«ä¸€ä¸ª commit') &&
              body.includes('æˆ‘ä½¿ç”¨äº† rebase è€Œä¸æ˜¯ merge');
            if (!hasChecklist) {
              validationErrors.push('âŒ **æ£€æŸ¥æ¸…å•æœªå®Œæˆ**');
              debugInfo.push('æœªæ‰¾åˆ°å®Œæ•´çš„æ£€æŸ¥æ¸…å•ï¼ˆéœ€è¦åŒ…å«æ‰€æœ‰å¿…é€‰é¡¹å¹¶æ ‡è®°ä¸ºå·²å®Œæˆï¼‰');
            } else {
              console.log('âœ… æ£€æŸ¥æ¸…å•æ£€æŸ¥é€šè¿‡');
            }

            if (validationErrors.length > 0) {
              console.log('âŒ PR æ ¼å¼éªŒè¯å¤±è´¥');
              console.log('é”™è¯¯è¯¦æƒ…:', validationErrors);
              
              // æ·»åŠ æ ‡ç­¾ï¼ˆé¦–æ¬¡åªæ·»åŠ  needs-infoï¼‰
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  labels: ['needs-info']
                });
                console.log('âœ… å·²æ·»åŠ  needs-info æ ‡ç­¾');
              } catch (e) {
                console.log('âš ï¸ æ·»åŠ æ ‡ç­¾å¤±è´¥:', e.message);
              }
              
              // æ·»åŠ è¯¦ç»†è¯„è®º
              const commentBody = `âš ï¸ **PR æ ¼å¼éªŒè¯å¤±è´¥**\n\n### âŒ å‘ç°çš„é—®é¢˜ï¼š\n\n${validationErrors.join('\n\n')}\n\n### âš ï¸ é‡è¦æé†’\n- ä¸ç¬¦åˆæ ¼å¼è¦æ±‚çš„ PR å°†è¢«æ ‡è®°ä¸º invalid\n- è¯·ä½¿ç”¨æä¾›çš„æ¨¡æ¿åˆ›å»º PR\n\nè¯·å®Œå–„ä¿¡æ¯åé‡æ–°æäº¤ï¼Œè°¢è°¢ï¼`;
              
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: commentBody
                });
                console.log('âœ… å·²æ·»åŠ è¯¦ç»†è¯„è®º');
              } catch (e) {
                console.log('âš ï¸ æ·»åŠ è¯„è®ºå¤±è´¥:', e.message);
              }
              
              core.setFailed(`PR format validation failed: ${validationErrors.join(', ')}`);
            } else {
              console.log('âœ… PR æ ¼å¼éªŒè¯é€šè¿‡');
              
              // ç§»é™¤ invalid å’Œ needs-info æ ‡ç­¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
              const labelsToRemove = ['invalid', 'needs-info'];
              for (const label of labelsToRemove) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number,
                    name: label
                  });
                  console.log(`âœ… å·²ç§»é™¤ ${label} æ ‡ç­¾`);
                } catch (e) {
                  // æ ‡ç­¾ä¸å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
                  console.log(`â„¹ï¸ ${label} æ ‡ç­¾ä¸å­˜åœ¨ï¼Œæ— éœ€ç§»é™¤`);
                }
              }
              
              // æ·»åŠ æˆåŠŸè¯„è®º
              const successComment = `âœ… **PR æ ¼å¼éªŒè¯é€šè¿‡ï¼**\n\næ‰€æœ‰æ ¼å¼è¦æ±‚éƒ½å·²æ»¡è¶³ï¼ŒPR å·²å‡†å¤‡å°±ç»ªã€‚`;
              
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: successComment
                });
                console.log('âœ… å·²æ·»åŠ æˆåŠŸè¯„è®º');
              } catch (e) {
                console.log('âš ï¸ æ·»åŠ æˆåŠŸè¯„è®ºå¤±è´¥:', e.message);
              }
            }
